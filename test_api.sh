#!/bin/bash

# API Test Script for Sharpe TCN Lab
# 
# IMPORTANT: Start the API first with:
# cd /Users/zayedumer/Documents/Personal-Projects/riskmap
# PYTHONPATH=. uvicorn quant_tcn_riskmap.api:app --reload

BASE_URL="http://localhost:8000"

echo "=== Testing Sharpe TCN Lab API ==="
echo ""

# Test 1: Start a backtest run
echo "1. Starting backtest on QQQ (2020-2023)..."
RUN_RESPONSE=$(curl -s -X POST "$BASE_URL/runs" \
  -H "Content-Type: application/json" \
  -d '{
    "ticker": "QQQ",
    "start_date": "2020-01-01",
    "end_date": "2023-01-01",
    "tau": 0.1,
    "target_sigma": 0.15,
    "w_min": -1.0,
    "w_max": 1.0,
    "tc_bps": 3.0
  }')

echo "$RUN_RESPONSE" | python3 -m json.tool
RUN_ID=$(echo "$RUN_RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['run_id'])" 2>/dev/null)
echo ""

# Test 2: Get backtest results
if [ ! -z "$RUN_ID" ]; then
  echo "2. Fetching results for run ID: $RUN_ID..."
  curl -s -X GET "$BASE_URL/runs/$RUN_ID" | python3 -m json.tool
  echo ""
fi

# Test 3: Make a prediction (requires trained model)
echo "3. Making a prediction with sample features..."
curl -s -X POST "$BASE_URL/predict" \
  -H "Content-Type: application/json" \
  -d '{
    "features": [
      [0.001, 0.02, 45.5, 0.0012, 0.0008, 0.0004, 0.003, 0.5, 0.015, 0.008, 0.05, 0.03, 0.012, 65.2],
      [0.002, 0.021, 46.2, 0.0013, 0.0009, 0.0004, 0.004, 0.6, 0.016, 0.009, 0.06, 0.04, 0.013, 66.1],
      [0.0015, 0.019, 44.8, 0.0011, 0.0007, 0.0004, 0.002, 0.4, 0.014, 0.007, 0.04, 0.02, 0.011, 64.5],
      [0.003, 0.022, 47.1, 0.0014, 0.001, 0.0004, 0.005, 0.7, 0.017, 0.01, 0.07, 0.05, 0.014, 67.3],
      [0.0012, 0.018, 43.9, 0.001, 0.0006, 0.0003, 0.001, 0.3, 0.013, 0.006, 0.03, 0.01, 0.01, 63.8],
      [0.0025, 0.023, 48.5, 0.0015, 0.0011, 0.0004, 0.006, 0.8, 0.018, 0.011, 0.08, 0.06, 0.015, 68.7],
      [0.0018, 0.02, 45.3, 0.0012, 0.0008, 0.0004, 0.003, 0.5, 0.015, 0.008, 0.05, 0.03, 0.012, 65.0],
      [0.0022, 0.021, 46.7, 0.0013, 0.0009, 0.0004, 0.004, 0.6, 0.016, 0.009, 0.06, 0.04, 0.013, 66.5],
      [0.0016, 0.019, 44.2, 0.0011, 0.0007, 0.0003, 0.002, 0.4, 0.014, 0.007, 0.04, 0.02, 0.011, 64.0],
      [0.0028, 0.024, 49.1, 0.0016, 0.0012, 0.0004, 0.007, 0.9, 0.019, 0.012, 0.09, 0.07, 0.016, 69.5],
      [0.002, 0.021, 46.0, 0.0013, 0.0009, 0.0004, 0.004, 0.6, 0.016, 0.009, 0.06, 0.04, 0.013, 66.0],
      [0.0024, 0.022, 47.5, 0.0014, 0.001, 0.0004, 0.005, 0.7, 0.017, 0.01, 0.07, 0.05, 0.014, 67.8],
      [0.0017, 0.02, 45.8, 0.0012, 0.0008, 0.0004, 0.003, 0.5, 0.015, 0.008, 0.05, 0.03, 0.012, 65.5],
      [0.0021, 0.021, 46.4, 0.0013, 0.0009, 0.0004, 0.004, 0.6, 0.016, 0.009, 0.06, 0.04, 0.013, 66.3],
      [0.0019, 0.02, 45.1, 0.0012, 0.0008, 0.0004, 0.003, 0.5, 0.015, 0.008, 0.05, 0.03, 0.012, 64.8],
      [0.0026, 0.023, 48.2, 0.0015, 0.0011, 0.0004, 0.006, 0.8, 0.018, 0.011, 0.08, 0.06, 0.015, 68.4],
      [0.0014, 0.019, 44.5, 0.0011, 0.0007, 0.0003, 0.002, 0.4, 0.014, 0.007, 0.04, 0.02, 0.011, 64.2],
      [0.0023, 0.022, 47.8, 0.0014, 0.001, 0.0004, 0.005, 0.7, 0.017, 0.01, 0.07, 0.05, 0.014, 68.0],
      [0.0015, 0.019, 44.9, 0.0011, 0.0007, 0.0004, 0.002, 0.4, 0.014, 0.007, 0.04, 0.02, 0.011, 64.6],
      [0.0027, 0.023, 48.8, 0.0015, 0.0011, 0.0004, 0.006, 0.8, 0.018, 0.011, 0.08, 0.06, 0.015, 69.1],
      [0.002, 0.021, 46.1, 0.0013, 0.0009, 0.0004, 0.004, 0.6, 0.016, 0.009, 0.06, 0.04, 0.013, 66.1],
      [0.0024, 0.022, 47.6, 0.0014, 0.001, 0.0004, 0.005, 0.7, 0.017, 0.01, 0.07, 0.05, 0.014, 67.9],
      [0.0018, 0.02, 45.4, 0.0012, 0.0008, 0.0004, 0.003, 0.5, 0.015, 0.008, 0.05, 0.03, 0.012, 65.1],
      [0.0022, 0.021, 46.8, 0.0013, 0.0009, 0.0004, 0.004, 0.6, 0.016, 0.009, 0.06, 0.04, 0.013, 66.6],
      [0.0016, 0.019, 44.3, 0.0011, 0.0007, 0.0003, 0.002, 0.4, 0.014, 0.007, 0.04, 0.02, 0.011, 64.1],
      [0.0029, 0.024, 49.3, 0.0016, 0.0012, 0.0004, 0.007, 0.9, 0.019, 0.012, 0.09, 0.07, 0.016, 69.7],
      [0.002, 0.021, 46.2, 0.0013, 0.0009, 0.0004, 0.004, 0.6, 0.016, 0.009, 0.06, 0.04, 0.013, 66.2],
      [0.0025, 0.022, 47.7, 0.0014, 0.001, 0.0004, 0.005, 0.7, 0.017, 0.01, 0.07, 0.05, 0.014, 68.1],
      [0.0017, 0.02, 45.6, 0.0012, 0.0008, 0.0004, 0.003, 0.5, 0.015, 0.008, 0.05, 0.03, 0.012, 65.3],
      [0.0021, 0.021, 46.5, 0.0013, 0.0009, 0.0004, 0.004, 0.6, 0.016, 0.009, 0.06, 0.04, 0.013, 66.4],
      [0.0019, 0.02, 45.2, 0.0012, 0.0008, 0.0004, 0.003, 0.5, 0.015, 0.008, 0.05, 0.03, 0.012, 64.9],
      [0.0026, 0.023, 48.4, 0.0015, 0.0011, 0.0004, 0.006, 0.8, 0.018, 0.011, 0.08, 0.06, 0.015, 68.6],
      [0.0013, 0.019, 44.6, 0.0011, 0.0007, 0.0003, 0.002, 0.4, 0.014, 0.007, 0.04, 0.02, 0.011, 64.3],
      [0.0023, 0.022, 47.9, 0.0014, 0.001, 0.0004, 0.005, 0.7, 0.017, 0.01, 0.07, 0.05, 0.014, 68.2],
      [0.0015, 0.019, 45.0, 0.0011, 0.0007, 0.0004, 0.002, 0.4, 0.014, 0.007, 0.04, 0.02, 0.011, 64.7],
      [0.0028, 0.024, 49.0, 0.0016, 0.0012, 0.0004, 0.007, 0.9, 0.019, 0.012, 0.09, 0.07, 0.016, 69.4],
      [0.002, 0.021, 46.3, 0.0013, 0.0009, 0.0004, 0.004, 0.6, 0.016, 0.009, 0.06, 0.04, 0.013, 66.3],
      [0.0024, 0.022, 47.4, 0.0014, 0.001, 0.0004, 0.005, 0.7, 0.017, 0.01, 0.07, 0.05, 0.014, 67.7],
      [0.0018, 0.02, 45.5, 0.0012, 0.0008, 0.0004, 0.003, 0.5, 0.015, 0.008, 0.05, 0.03, 0.012, 65.2],
      [0.0022, 0.021, 46.9, 0.0013, 0.0009, 0.0004, 0.004, 0.6, 0.016, 0.009, 0.06, 0.04, 0.013, 66.7],
      [0.0016, 0.019, 44.4, 0.0011, 0.0007, 0.0003, 0.002, 0.4, 0.014, 0.007, 0.04, 0.02, 0.011, 64.2],
      [0.003, 0.024, 49.5, 0.0016, 0.0012, 0.0004, 0.007, 0.9, 0.019, 0.012, 0.09, 0.07, 0.016, 69.9],
      [0.002, 0.021, 46.4, 0.0013, 0.0009, 0.0004, 0.004, 0.6, 0.016, 0.009, 0.06, 0.04, 0.013, 66.4],
      [0.0025, 0.022, 47.8, 0.0014, 0.001, 0.0004, 0.005, 0.7, 0.017, 0.01, 0.07, 0.05, 0.014, 68.2],
      [0.0017, 0.02, 45.7, 0.0012, 0.0008, 0.0004, 0.003, 0.5, 0.015, 0.008, 0.05, 0.03, 0.012, 65.4],
      [0.0021, 0.021, 46.6, 0.0013, 0.0009, 0.0004, 0.004, 0.6, 0.016, 0.009, 0.06, 0.04, 0.013, 66.5],
      [0.0019, 0.02, 45.3, 0.0012, 0.0008, 0.0004, 0.003, 0.5, 0.015, 0.008, 0.05, 0.03, 0.012, 65.0],
      [0.0027, 0.023, 48.6, 0.0015, 0.0011, 0.0004, 0.006, 0.8, 0.018, 0.011, 0.08, 0.06, 0.015, 68.8],
      [0.0014, 0.019, 44.7, 0.0011, 0.0007, 0.0003, 0.002, 0.4, 0.014, 0.007, 0.04, 0.02, 0.011, 64.4],
      [0.0023, 0.022, 48.0, 0.0014, 0.001, 0.0004, 0.005, 0.7, 0.017, 0.01, 0.07, 0.05, 0.014, 68.3],
      [0.0015, 0.019, 45.1, 0.0011, 0.0007, 0.0004, 0.002, 0.4, 0.014, 0.007, 0.04, 0.02, 0.011, 64.8],
      [0.0028, 0.024, 49.2, 0.0016, 0.0012, 0.0004, 0.007, 0.9, 0.019, 0.012, 0.09, 0.07, 0.016, 69.6],
      [0.002, 0.021, 46.5, 0.0013, 0.0009, 0.0004, 0.004, 0.6, 0.016, 0.009, 0.06, 0.04, 0.013, 66.5],
      [0.0024, 0.022, 47.9, 0.0014, 0.001, 0.0004, 0.005, 0.7, 0.017, 0.01, 0.07, 0.05, 0.014, 68.3],
      [0.0018, 0.02, 45.8, 0.0012, 0.0008, 0.0004, 0.003, 0.5, 0.015, 0.008, 0.05, 0.03, 0.012, 65.5],
      [0.0022, 0.021, 47.0, 0.0013, 0.0009, 0.0004, 0.004, 0.6, 0.016, 0.009, 0.06, 0.04, 0.013, 66.8],
      [0.0016, 0.019, 44.5, 0.0011, 0.0007, 0.0003, 0.002, 0.4, 0.014, 0.007, 0.04, 0.02, 0.011, 64.3],
      [0.0029, 0.024, 49.6, 0.0016, 0.0012, 0.0004, 0.007, 0.9, 0.019, 0.012, 0.09, 0.07, 0.016, 70.0],
      [0.002, 0.021, 46.6, 0.0013, 0.0009, 0.0004, 0.004, 0.6, 0.016, 0.009, 0.06, 0.04, 0.013, 66.6],
      [0.0025, 0.022, 48.0, 0.0014, 0.001, 0.0004, 0.005, 0.7, 0.017, 0.01, 0.07, 0.05, 0.014, 68.4],
      [0.0017, 0.02, 45.9, 0.0012, 0.0008, 0.0004, 0.003, 0.5, 0.015, 0.008, 0.05, 0.03, 0.012, 65.6],
      [0.0021, 0.021, 46.7, 0.0013, 0.0009, 0.0004, 0.004, 0.6, 0.016, 0.009, 0.06, 0.04, 0.013, 66.7],
      [0.0019, 0.02, 45.4, 0.0012, 0.0008, 0.0004, 0.003, 0.5, 0.015, 0.008, 0.05, 0.03, 0.012, 65.1]
    ],
    "current_sigma": 0.021
  }' | python3 -m json.tool

echo ""
echo "=== API Tests Complete ==="
